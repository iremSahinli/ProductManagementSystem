@model IEnumerable<ManagmentSystem.Presentation.Areas.Admin.Models.UserVMs.AdminUserListVM>

@{
    ViewData["Title"] = "Kullanıcılar";
}

<h1 class="text-center">Users</h1>

<div class="button-container mb-3">
    <a href="@Url.Action("Create", "AdminUser")" class="btn btn-success">Create New User</a>
</div>

<form method="post" asp-controller="AdminUser" asp-action="UpdateLockoutStatus">
    @Html.AntiForgeryToken() <!-- koruma için Antiforgery token -->
</form>

<div class="card">
    <div class="table-responsive">
        <table class="table align-items-center mb-0">
            <thead>
                <tr>

                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">First Name</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Last Name</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Mail</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Lock or Unlock Switch</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => item.FirstName)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.LastName)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Mail)
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="lockoutEnabledSwitch-@item.Id"
                                       data-user-id="@item.Id"
                                @(item.LockoutEnabled ? "checked" : "") />
                                <label class="form-check-label" for="lockoutEnabledSwitch-@item.Id"></label>
                            </div>
                        </td>
                        <td>
                            <a href="@Url.Action("Edit", "AdminUser", new { id = item.Id })" class="btn btn-primary">Update</a>
                            <a href="@Url.Action("UserDetail", "AdminUser", new { id = item.Id })" class="btn btn-info">Details</a>
                            <a href="@Url.Action("Delete", "AdminUser", new { id = item.Id })" class="btn btn-danger">Delete</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .form-check-input {
        width: 60px;
        height: 34px;
    }

        .form-check-input:checked {
            background-color: green;
        }

        .form-check-input:not(:checked) {
            background-color: red;
        }

    .form-check-label {
        display: inline-block;
        width: 60px;
        height: 34px;
        position: relative;
        cursor: pointer;
    }
</style>

@section Scripts {
    <script>
        document.querySelectorAll('input[type="checkbox"][id^="lockoutEnabledSwitch-"]').forEach(function (element) {
            element.addEventListener('change', function () {
                var userId = this.getAttribute('data-user-id');
                var isEnabled = this.checked;
                var token = $('input[name="__RequestVerificationToken"]').val(); // Antiforgery token

                console.log("Kullanıcı ID: " + userId + " | Kilit Durumu: " + isEnabled);

                $.ajax({
                    url: '/Admin/AdminUser/UpdateLockoutStatus',
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: token,  // Antiforgery token
                        userId: userId,
                        lockoutEnabled: isEnabled
                    },
                    success: function (response) {
                        console.log("Başarılı: Kullanıcı durumu güncellendi.");
                        alert('Kullanıcı durumu başarıyla güncellendi.');
                    },
                    error: function (error) {
                        console.log("Hata:", error);
                        alert('Kullanıcı durumu güncellenirken bir hata oluştu.');
                        element.checked = !isEnabled; // Hata olursa Switch'i eski durumuna geri döndür.
                    }
                });
            });
        });
    </script>
}
